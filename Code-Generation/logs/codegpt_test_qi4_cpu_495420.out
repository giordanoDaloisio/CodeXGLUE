========================================
Testing CodeGPT su HumanEval
========================================
Model: ./codegen_finetuned
Output: ./codegen_finetuned
Epochs: 3
Batch size: 8
========================================
WARNING:bitsandbytes.cextension:The installed version of bitsandbytes was compiled without GPU support. 8-bit optimizers and GPU quantization are unavailable.
[Info] Device: cpu
[Info] Carico modello da ./codegen_finetuned
[Info] Carico HumanEval da ../data/HumanEval.jsonl.gz
[Info] Num problemi: 164
[Info] Modello caricato: codegen
[Info] Num parameters: 354,858,103
Size (MB): 554.497673
[Info] Generazione completions (samples per task: 20)
Generating:   0%|          | 0/164 [00:00<?, ?it/s]Generating:   0%|          | 0/164 [00:05<?, ?it/s]
Traceback (most recent call last):
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/cpp_extension.py", line 2506, in _run_ninja_build
    subprocess.run(
    ~~~~~~~~~~~~~~^
        command,
        ^^^^^^^^
    ...<3 lines>...
        check=True,
        ^^^^^^^^^^^
        env=env)
        ^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/subprocess.py", line 579, in run
    raise CalledProcessError(retcode, process.args,
                             output=stdout, stderr=stderr)
subprocess.CalledProcessError: Command '['ninja', '-v']' returned non-zero exit status 1.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/NFSHOME/gdaloisio/code/CodeXGLUE/Code-Generation/code/evaluate.py", line 373, in <module>
    evaluate_humaneval(
    ~~~~~~~~~~~~~~~~~~^
        model_path=args.model_path,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<8 lines>...
        args = args
        ^^^^^^^^^^^
    )
    ^
  File "/NFSHOME/gdaloisio/code/CodeXGLUE/Code-Generation/code/evaluate.py", line 245, in evaluate_humaneval
    samples, times = generate_completions(
                     ~~~~~~~~~~~~~~~~~~~~^
        model=model,
        ^^^^^^^^^^^^
    ...<6 lines>...
        device=device
        ^^^^^^^^^^^^^
    )
    ^
  File "/NFSHOME/gdaloisio/code/CodeXGLUE/Code-Generation/code/evaluate.py", line 107, in generate_completions
    outputs = model.generate(
        input_ids,
    ...<7 lines>...
        eos_token_id=tokenizer.eos_token_id,
    )
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/_contextlib.py", line 116, in decorate_context
    return func(*args, **kwargs)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/transformers/generation/utils.py", line 2597, in generate
    result = self._sample(
        input_ids,
    ...<5 lines>...
        **model_kwargs,
    )
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/transformers/generation/utils.py", line 3557, in _sample
    outputs = self(**model_inputs, return_dict=True)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/transformers/models/codegen/modeling_codegen.py", line 672, in forward
    transformer_outputs = self.transformer(
        input_ids,
    ...<10 lines>...
        cache_position=cache_position,
    )
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/transformers/models/codegen/modeling_codegen.py", line 453, in forward
    outputs = block(
        hidden_states=hidden_states,
    ...<6 lines>...
        cache_position=cache_position,
    )
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/transformers/models/codegen/modeling_codegen.py", line 270, in forward
    attn_outputs = self.attn(
        hidden_states=hidden_states,
    ...<6 lines>...
        cache_position=cache_position,
    )
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/transformers/models/codegen/modeling_codegen.py", line 162, in forward
    qkv = self.qkv_proj(hidden_states)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/nn/qlinear.py", line 50, in forward
    return torch.nn.functional.linear(input, self.qweight, bias=self.bias)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/weights/qbits.py", line 266, in __torch_function__
    return qlinear(*args, **kwargs)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/weights/qbits.py", line 264, in qlinear
    return QuantizedLinearFunction.apply(input, other, bias)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/autograd/function.py", line 575, in apply
    return super().apply(*args, **kwargs)  # type: ignore[misc]
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/function.py", line 44, in forward
    output = torch.matmul(input, other.t())
                                 ~~~~~~~^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/weights/qbits.py", line 272, in __torch_function__
    return func(*args, **kwargs)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/weights/qbits.py", line 302, in __torch_dispatch__
    return qfallback(op, *args, **kwargs)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/qtensor.py", line 28, in qfallback
    args, kwargs = pytree.tree_map_only(QTensor, lambda x: x.dequantize(), (args, kwargs or {}))
                   ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/_pytree.py", line 1333, in tree_map_only
    return tree_map(map_only(type_or_types_or_pred)(func), tree, is_leaf=is_leaf)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/_pytree.py", line 1145, in tree_map
    return treespec.unflatten(map(func, *flat_args))
           ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/_pytree.py", line 982, in unflatten
    leaves = list(leaves)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/_pytree.py", line 1263, in wrapped
    return func(x)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/qtensor.py", line 28, in <lambda>
    args, kwargs = pytree.tree_map_only(QTensor, lambda x: x.dequantize(), (args, kwargs or {}))
                                                           ~~~~~~~~~~~~^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/qbits.py", line 68, in dequantize
    return QBitsDequantizer.apply(self)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/autograd/function.py", line 575, in apply
    return super().apply(*args, **kwargs)  # type: ignore[misc]
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/qbits.py", line 31, in forward
    data = t._data.unpack()
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/tensor/packed.py", line 101, in unpack
    unpacked_data = torch.ops.quanto.unpack(self._data, self._bits)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/_ops.py", line 1158, in __call__
    return self._op(*args, **(kwargs or {}))
           ~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/library/extensions/cpp/__init__.py", line 36, in unpack_cpp
    return ext.lib.unpack(t, bits)
           ^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/library/extensions/extension.py", line 44, in lib
    self._lib = load(
                ~~~~^
        name=self.name,
        ^^^^^^^^^^^^^^^
    ...<3 lines>...
        build_directory=self.build_directory,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/cpp_extension.py", line 1623, in load
    return _jit_compile(
        name,
    ...<11 lines>...
        is_standalone,
        keep_intermediates=keep_intermediates)
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/cpp_extension.py", line 2076, in _jit_compile
    _write_ninja_file_and_build_library(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        name=name,
        ^^^^^^^^^^
    ...<9 lines>...
        with_sycl=with_sycl,
        ^^^^^^^^^^^^^^^^^^^^
        is_standalone=is_standalone)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/cpp_extension.py", line 2222, in _write_ninja_file_and_build_library
    _run_ninja_build(
    ~~~~~~~~~~~~~~~~^
        build_directory,
        ^^^^^^^^^^^^^^^^
        verbose,
        ^^^^^^^^
        error_prefix=f"Error building extension '{name}'")
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/utils/cpp_extension.py", line 2522, in _run_ninja_build
    raise RuntimeError(message) from e
RuntimeError: Error building extension 'quanto_cpp': [1/3] c++ -MMD -MF unpack.o.d -DTORCH_EXTENSION_NAME=quanto_cpp -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"_gcc\" -DPYBIND11_STDLIB=\"_libstdcpp\" -DPYBIND11_BUILD_ABI=\"_cxxabi1016\" -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/api/include -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/include/python3.13 -D_GLIBCXX_USE_CXX11_ABI=1 -fPIC -std=c++17 -O3 -c /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/library/extensions/cpp/unpack.cpp -o unpack.o 
FAILED: unpack.o 
c++ -MMD -MF unpack.o.d -DTORCH_EXTENSION_NAME=quanto_cpp -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"_gcc\" -DPYBIND11_STDLIB=\"_libstdcpp\" -DPYBIND11_BUILD_ABI=\"_cxxabi1016\" -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/api/include -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/include/python3.13 -D_GLIBCXX_USE_CXX11_ABI=1 -fPIC -std=c++17 -O3 -c /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/library/extensions/cpp/unpack.cpp -o unpack.o 
In file included from /opt/ohpc/pub/compiler/gcc/12.3.0/include/c++/12.3.0/x86_64-pc-linux-gnu/bits/c++config.h:655,
                 from /opt/ohpc/pub/compiler/gcc/12.3.0/include/c++/12.3.0/cstddef:49,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/c10/core/DeviceType.h:10,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/c10/core/Device.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/ATen/core/TensorBody.h:11,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/ATen/core/Tensor.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/ATen/Tensor.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/autograd/function_hook.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/autograd/cpp_hook.h:2,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/autograd/variable.h:6,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/autograd/autograd.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/api/include/torch/autograd.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/api/include/torch/all.h:7,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/extension.h:5,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/library/extensions/cpp/unpack.h:15,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/library/extensions/cpp/unpack.cpp:15:
/opt/ohpc/pub/compiler/gcc/12.3.0/include/c++/12.3.0/x86_64-pc-linux-gnu/bits/os_defines.h:39:10: fatal error: features.h: No such file or directory
   39 | #include <features.h>
      |          ^~~~~~~~~~~~
compilation terminated.
[2/3] c++ -MMD -MF pybind_module.o.d -DTORCH_EXTENSION_NAME=quanto_cpp -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"_gcc\" -DPYBIND11_STDLIB=\"_libstdcpp\" -DPYBIND11_BUILD_ABI=\"_cxxabi1016\" -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/api/include -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/include/python3.13 -D_GLIBCXX_USE_CXX11_ABI=1 -fPIC -std=c++17 -O3 -c /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/library/extensions/cpp/pybind_module.cpp -o pybind_module.o 
FAILED: pybind_module.o 
c++ -MMD -MF pybind_module.o.d -DTORCH_EXTENSION_NAME=quanto_cpp -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"_gcc\" -DPYBIND11_STDLIB=\"_libstdcpp\" -DPYBIND11_BUILD_ABI=\"_cxxabi1016\" -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/api/include -isystem /NFSHOME/gdaloisio/miniconda3/envs/codex/include/python3.13 -D_GLIBCXX_USE_CXX11_ABI=1 -fPIC -std=c++17 -O3 -c /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/library/extensions/cpp/pybind_module.cpp -o pybind_module.o 
In file included from /opt/ohpc/pub/compiler/gcc/12.3.0/include/c++/12.3.0/x86_64-pc-linux-gnu/bits/c++config.h:655,
                 from /opt/ohpc/pub/compiler/gcc/12.3.0/include/c++/12.3.0/cstddef:49,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/c10/core/DeviceType.h:10,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/c10/core/Device.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/ATen/core/TensorBody.h:11,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/ATen/core/Tensor.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/ATen/Tensor.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/autograd/function_hook.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/autograd/cpp_hook.h:2,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/autograd/variable.h:6,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/autograd/autograd.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/api/include/torch/autograd.h:3,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/csrc/api/include/torch/all.h:7,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/torch/include/torch/extension.h:5,
                 from /NFSHOME/gdaloisio/miniconda3/envs/codex/lib/python3.13/site-packages/optimum/quanto/library/extensions/cpp/pybind_module.cpp:15:
/opt/ohpc/pub/compiler/gcc/12.3.0/include/c++/12.3.0/x86_64-pc-linux-gnu/bits/os_defines.h:39:10: fatal error: features.h: No such file or directory
   39 | #include <features.h>
      |          ^~~~~~~~~~~~
compilation terminated.
ninja: build stopped: subcommand failed.


========================================
Testing completato!
========================================
